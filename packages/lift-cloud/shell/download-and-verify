#!/usr/bin/env bash

read -r -d '' HELP_TEXT <<-HELP
Usage: download-and-verify [OPTION]... <URL>
Downloads a file, and verifies it matches a checksum.

If this command completes successfully, then the file with the supplied URL will be downloaded and
saved at the path given by '--destination.' If the download fails, or if the checksum is invalid, 
then the destination will not have been changed.

Requires the verify-single-sha256 utility to be on the path.

The following options are required:
      --destination=<dest>  directory in which the downloaded file be saved
      --filename=<blah>     name of the file, as it appers in the sha256sums file (inferred from URL by default)
      --sha256-url=<url>    URL to a file generated by sha256sum, containing the downloaded file's checksum
      --url=<url>           URL of the file to download

The following additional arguments may be specified:
  -h, --help                show this help message
HELP

function parse_args ()
{
  for i in "$@"; do
    case $i in
        --destination=*)
        DESTINATION="${i#*=}"
        shift
        ;;
        --filename=*)
        FILENAME="${i#*=}"
        shift
        ;;
        --sha256-url=*)
        SHA256_URL="${i#*=}"
        shift
        ;;
        -h|--help)
        SHOW_HELP=true
        shift
        ;;
        --url=*)
        URL="${i#*=}"
        shift
        ;;
        *)
        # default argument
        ;;
    esac
  done
}

parse_args "$@"|| exit 1

if [[ "${SHOW_HELP}" == "true" ]]; then
  echo "${HELP_TEXT}"
  exit 0
fi

: ${URL?You must supply a URL argument.}
: ${DESTINATION?You must supply a '--destination' argument.}
: ${SHA256_URL?You must supply a '--sha256-url' argument.}

TEMP_DOWNLOAD_DIR=$(mktemp -d "download-XXXXXXXXXX")
trap 'rm -rf -- "${TEMP_DOWNLOAD_DIR}"' INT TERM HUP EXIT

# if no filename given as argument, extract from the URL
# See: https://unix.stackexchange.com/a/64435
if [[ -z "${FILENAME}" ]]; then
  FILENAME="${URL##*/}"
fi

TEMP_PATH="${TEMP_DOWNLOAD_DIR}/${FILENAME}"
TEMP_CHECKSUM_PATH="${TEMP_PATH}.sha256"

# download to temp file
curl --location --silent --output "${TEMP_PATH}" "${URL}"
curl --location --silent --output "${TEMP_CHECKSUM_PATH}" "${SHA256_URL}"

# verify checksums
verify-single-sha256 \
  --quiet \
  --file="${FILENAME}" \
  --sums="${TEMP_CHECKSUM_PATH}" \
    || exit 1

# and copy to final location, if it is valid
mkdir -p $(dirname "${DESTINATION}")
mv "${TEMP_PATH}" "${DESTINATION}"
