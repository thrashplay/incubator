# Generate Config Versions

The Generate Config Versions plugin can be used to generate hash-based version strings for Docker Swarm
configs and secrets. These version strings can then be used to generate unique-enough names for
these resources, allowing them to be rotated in an automated fashion. For more information on the 
Node.js library used to perform this task, see: 
https://github.com/thrashplay/incubator-node/tree/master/packages/node/devops/config-version-helper.

## Overview

Docker Swarm configuration resources are immutable. This means that deploying new configuration
values requires stopping the service(s) using that configuration, deleting the old configuration,
and then deploying the new configuration. [The Docker documentation](https://docs.docker.com/engine/swarm/configs/#example-rotate-a-config) suggests an alternate appraoch of *rotating* configuration, which means
you deploy a new version of the config with a new name, and then redeploy the relevant services
with references to the new config.

In order to automate this process, a continuous deployment system needs a way to generate (mostly)
unique new names for configurations. This plugin implements a solution to this problem that uses
hashes of the configuration's content to generate a name.

This plugin makes the following assumptions about the projects it runs in:

  1. Stacks requiring configuration are specified in one or more Docker compose Yaml files
  2. Each Docker compose file contains zero or more entries in the top-level `configs` section
  3. Each such top-level config specifies a `name` attribute that includes a specially-crafted 
  environment variable that will be populated with a version string

### Output

This plugin will generate an environment file (named `.env` by default) for each input Docker compose
file. This file will contain zero or more environment variable definitions -- one definition
for every non-external entry in the top-level `configs` section of the compose file. The name of 
each variable is generated by converting the config's ID to "snake case", and then changing every
letter to uppercase. After this, the string `_VERSION` is appended to the name. For example, 
`my-config` becomes `MY_CONFIG_VERSION` and `test` becomes `TEST_VERSION`.

The value of each variable will be the first eight characters of the hex representation of the
SHA256 hash of the configuration's content. Assuming the generated `.env` file is used when
deploying the stack, using these environment variables in the `name` property of the associated
configuration entries will ensure unique names are create.

## Basic Usage

The following example shows input and output files for the most common use case -- generating
an environment file for every Docker compose Yaml file in a list.

### Pipeline Configuration

```yaml
kind: pipeline
name: default

steps:
- name: generate-versions
  image: thrashplay/generate-versions
  settings:
    compose_file: <path>/docker-compose.yaml
```

### \<path>/docker-compose.yaml

```yaml
version: '3.7'
services:
  nginx:
    image: nginx
    configs:
      - source: nginx-config
        target: /etc/nginx/nginx.conf
    environment:
    ports:
      - "80:80"

configs:
  nginx-config:
    name: nginx-config-${NGINX_CONFIG_VERSION:-default}
    file: ./config/nginx.conf
  other:
    name: any-string-${OTHER_VERSION:-default}
    file: ./config/other.conf
```

### Example Output

Given the above pipeline configuration and example `docker-compose.yaml file`, this plugin would
create the following content in \<path>/.env (the exact hashes would be different):

```bash
NGINX_CONFIG_VERSION=4f53cda1
OTHER_VERSION=4f53cda1
```

## Parameter Reference

- **configuration_file**   
   url of the Swarm Management configuration Yaml (defaults to swarm.management.yml)

- **docker_host**   
   url of the Docker host, as passed to the -H argument to Docker (defaults to tcp://localhost:2376)

- **docker_cacert**   
   path to the cacert file to use with Docker TLS

- **docker_cert**   
   path to the TLS certificate file to use with Docker

- **docker_key**   
  path to the TLS key file to use with Docker

- **use_tls**   
  whether the Docker connection should use TLS (if true, `docker_cacert`, `docker_cert`, and `docker_key` are required)