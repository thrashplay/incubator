kind: pipeline
name: deployment-agent

platform:
  arch: arm
  os: linux

steps:
- name: publish-image
  image: plugins/docker
  settings:
    repo: thrashplay/drone-deployment-agent
    tag: drone_test
    context: services/sophia/deployment-agent
    dockerfile: services/sophia/deployment-agent/Dockerfile
    username:
      from_secret: DOCKER_USERNAME
    password:
      from_secret: DOCKER_PASSWORD

- name: publish-manifest
  image: plugins/manifest:1.2
  settings:
    target: thrashplay/deployment-agent:drone_test
    spec: services/sophia/deployment-agent/manifest.tmpl
    tag: drone_test
    ignore_missing: true
    username:
      from_secret: DOCKER_USERNAME
    password:
      from_secret: DOCKER_PASSWORD
    platforms:
      - linux/arm

trigger:
  changeset:
    includes: [ services/sophia/deployment-agent/**, .drone.yaml ]