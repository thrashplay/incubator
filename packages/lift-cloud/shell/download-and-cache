#!/usr/bin/env bash

read -r -d '' HELP_TEXT <<-HELP
Usage: download-and-cache [OPTION]... <URL>
Downloads a file, if it does not already exist

If this command completes successfully, then the file with the supplied URL will be downloaded and
saved at the path given by '--destination.' If the file already existed, then it will not be changed.
If the file did not exist, it will be downloaded and saved at the destination. If the download 
fails, or if the checksum is invalid, then the destination will not have been changed.

Note that the --sha256-url argument is ONLY used to verify checksums when a file is downloaded. If a
cached copy is used, it is not reverified.

Requires the verify-single-sha256 and download-and-verify utilities to be on the path.

The following options are required:
      --destination=<dest>  directory in which the downloaded file be saved
      --filename=<blah>     name of the file, as it appers in the sha256sums file (inferred from URL by default)
      --keep-checksum       if this flag is specified, the checksum file be saved
      --sha256-url=<url>    URL to a file generated by sha256sum, containing the downloaded file's checksum
      --url=<url>           URL of the file to download

The following additional arguments may be specified:
  -h, --help                show this help message
HELP

function parse_args ()
{
  for i in "$@"; do
    case $i in
        --destination=*)
        DESTINATION="${i#*=}"
        shift
        ;;
        -h|--help)
        SHOW_HELP=true
        shift
        ;;
    esac
  done
}

parse_args "$@"|| exit 1

if [[ "${SHOW_HELP}" == "true" ]]; then
  echo "${HELP_TEXT}"
  exit 0
fi

: ${DESTINATION?You must supply a '--destination' argument.}

[[ -f "${DESTINATION}" ]] || download-and-verify "$@"
