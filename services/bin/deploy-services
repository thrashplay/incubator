#!/usr/bin/env sh

SCRIPT=$(readlink -f "$0")
DIR=$(dirname "$SCRIPT")

deploy_stack () {
  npx @pegasus-ops/config-version-helper "$DIR/../$1/docker-compose.yaml"
  set -a
  . "$DIR/../$1/config-versions.env"
  set +a

  docker stack deploy --compose-file "$DIR/../$1/docker-compose.yaml" $2
}

set -e
set -x

deploy_stack pegasus/nginx-proxy nginx-proxy
deploy_stack pegasus/hello-world hello-world
deploy_stack pegasus/dashboard dashboard