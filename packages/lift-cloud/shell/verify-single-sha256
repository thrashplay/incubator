#!/usr/bin/env bash

read -r -d '' HELP_TEXT <<-HELP
Usage: verify-single-sha256 [OPTION]...
Check a single file against a checksum generated with sha256sum.

The following options are required:
      --file=<path>   path to the file to verify
      --sums=<path>   path to checksum file generated by sha256sum

The following options control how much output is generated:
  -q, --quiet         don't print OK if file verifies successfully
      --status        status code shows success or failure of verification, only argument errors shown
  -h, --help          show this help message
HELP

function parse_args ()
{
  for i in "$@"; do
    case $i in
        --sums=*)
        SUMS_PATH="${i#*=}"
        shift
        ;;
        --file=*)
        FILE_TO_VERIFY="${i#*=}"
        shift
        ;;
        -q|--quiet)
        NO_STDOUT=true
        shift
        ;;
        --status)
        NO_STDOUT=true
        NO_STDERR=true
        shift
        ;;
        -h|--help)
        SHOW_HELP=true
        shift
        ;;
        *)
        # unknown option
        ;;
    esac
  done
}

regex_escape() {
  sed 's/[][\.|$(){}?+*^]/\\&/g' <<< "$*"
}

function print_err ()
{
   [[ "$NO_STDERR" == "true" ]] || (>&2 echo "$@")
}

function print_fatal ()
{
  >&2 echo "$@"
}

function print_out ()
{
  [[ "$NO_STDOUT" == "true" ]] || echo "$@"
}

parse_args "$@"

if [[ "${SHOW_HELP}" == "true" ]]; then
  echo "${HELP_TEXT}"
  exit 0
fi

# validate our arguments
: ${SUMS_PATH?You must supply a '--sums' argument.}
: ${FILE_TO_VERIFY?You must supply a '--file' argument.}

[[ -f "${SUMS_PATH}" ]] || \
  { print_fatal "Sums file path does not exist: ${SUMS_PATH}"; exit 1; }

DIRECTORY=$(dirname "${SUMS_PATH}")
[[ -f "${DIRECTORY}/${FILE_TO_VERIFY}" ]] || \
  { print_fatal "File to verify does not exist: ${FILE_TO_VERIFY}"; exit 1; }

CHECKSUM_LINES=$(cat "${SUMS_PATH}" | egrep "^.* [ *]$(regex_escape "${FILE_TO_VERIFY}")$")
[[ -n "${CHECKSUM_LINES}" ]] || \
  { print_fatal "No SHA256 checksum found for file: ${FILE_TO_VERIFY}"; exit 1; }

(
  cd "${DIRECTORY}" 
  echo -n "${CHECKSUM_LINES}" | sha256sum --status --check
) || { print_err "SHA256 checksum does not match for specified file: ${FILE_TO_VERIFY}"; exit 1; }

print_out "OK"