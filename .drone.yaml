kind: pipeline
type: docker
name: build-arm-images

platform:
  arch: arm
  os: linux

steps:
  - name: build-git-client
    image: plugins/docker
    depends_on: [ clone ]
    settings:
      context: packages/pegasus-ops/docker/git-client
      dockerfile: packages/pegasus-ops/docker/git-client/Dockerfile
      force_tag: true
      password:
        from_secret: DOCKER_PASSWORD
      repo: thrashplay/git-client
      tags:
        - latest
        - ${DRONE_BRANCH}
        - ${DRONE_BRANCH}-${DRONE_COMMIT}
      username: thrashplay
    when:
      changeset:
        includes: [ .drone.yaml, packages/pegasus-ops/docker/git-client/** ]

  - name: build-deployer
    image: plugins/docker
    depends_on: [ clone ]
    settings:
      context: packages/pegasus-ops/docker/deployer
      dockerfile: packages/pegasus-ops/docker/deployer/Dockerfile
      force_tag: true
      password:
        from_secret: DOCKER_PASSWORD
      repo: thrashplay/sophia-deployer
      tags:
        - latest
        - ${DRONE_BRANCH}
        - ${DRONE_BRANCH}-${DRONE_COMMIT}
      username: thrashplay
    when:
      changeset:
        includes: [ .drone.yaml, packages/pegasus-ops/docker/deployer/** ]

  - name: build-ddns-sidecar
    image: plugins/docker
    depends_on: [ clone ]
    settings:
      context: packages/pegasus-ops/docker/nginx-proxy/ddns-sidecar
      dockerfile: packages/pegasus-ops/docker/nginx-proxy/ddns-sidecar/Dockerfile
      force_tag: true
      password:
        from_secret: DOCKER_PASSWORD
      repo: thrashplay/ddns-sidecar
      tags:
        - latest
        - ${DRONE_BRANCH}
        - ${DRONE_BRANCH}-${DRONE_COMMIT}
      username: thrashplay
    when:
      changeset:
        includes: [ .drone.yaml, packages/pegasus-ops/docker/nginx-proxy/ddns-sidecar/** ]

  - name: build-nginx-with-certbot
    image: plugins/docker
    depends_on: [ clone ]
    settings:
      context: packages/pegasus-ops/docker/nginx-proxy/nginx-with-certbot
      dockerfile: packages/pegasus-ops/docker/nginx-proxy/nginx-with-certbot/Dockerfile
      force_tag: true
      password:
        from_secret: DOCKER_PASSWORD
      repo: thrashplay/nginx-with-certbot
      tags:
        - latest
        - ${DRONE_BRANCH}
        - ${DRONE_BRANCH}-${DRONE_COMMIT}
      username: thrashplay
    when:
      changeset:
        includes: [ .drone.yaml, packages/pegasus-ops/docker/nginx-proxy/nginx-with-certbot/** ]

  - name: build-homeassistant
    image: plugins/docker
    depends_on: [ clone ]
    settings:
      context: packages/pegasus-ops/docker/homeassistant
      dockerfile: packages/pegasus-ops/docker/homeassistant/Dockerfile
      force_tag: true
      password:
        from_secret: DOCKER_PASSWORD
      repo: thrashplay/homeassistant
      tags:
        - latest
        - ${DRONE_BRANCH}
        - ${DRONE_BRANCH}-${DRONE_COMMIT}
      username: thrashplay
    when:
      changeset:
        includes: [ .drone.yaml, packages/pegasus-ops/docker/homeassistant/** ]

trigger:
  changeset:
    includes: [ .drone.yaml, packages/pegasus-ops/docker/** ]
  branch:
    - master

---

kind: pipeline
type: docker
name: build-npm-packages

steps:
  - name: initialize
    image: alpine/git
    commands:
      - git config --local user.email drone@thrashplay.com
      - git config --local user.name Drone

  - name: bootstrap
    image: node:lts
    commands:
      - yarn install --frozen-lockfile --non-interactive
      - yarn lerna bootstrap

  - name: build
    image: node:lts
    commands:
      - yarn build

  - name: test
    image: node:lts
    commands:
      - yarn test

  # - name: fetch-tags
  #   image: drone/git
  #   commands:
  #     - git fetch --tags

  - name: bump-versions
    image: node:lts
    commands:
      # - sh .ci/amend-commit.sh
      - yarn lerna version --conventional-prerelease --preid next --amend --no-changelog --yes
      # - sh .ci/push-tags.sh
    when:
      branch:
        - master

  - name: authenticate-to-npm
    image: robertstettner/drone-npm-auth
    settings:
      path: ~
      token:
        from_secret: NPM_PUBLISH_TOKEN
    when:
      branch:
        - master

  - name: publish
    image: node:lts
    commands:
      - yarn lerna publish from-package --no-git-reset --dist-tag next --yes
    when:
      branch:
        - master

trigger:
  changeset:
    includes:
      - '.ci/**'
      - '.drone.yaml'
      - '.eslintignore'
      - '.eslintrc.js'
      - '@types/**'
      - 'babel.config.js'
      - 'build-lib/**'
      - 'jest.config.js'
      - 'lerna.json'
      - 'package.json'
      - 'patches/**'
      - 'packages/node/**'
      - 'tsconfig.*.json'
      - 'tsconfig.json'
      - 'yarn.lock'

---

kind: pipeline
type: docker
name: deploy-services

depends_on:
  - build-arm-images
  - build-npm-packages

platform:
  arch: arm
  os: linux

steps:
  - name: deploy
    image: thrashplay/sophia-deployer
    settings:
      docker_host: control.pegasus:2376
      docker_cacert:
        from_secret: DOCKER_CACERT
      docker_cert:
        from_secret: DOCKER_CERT
      docker_key:
        from_secret: DOCKER_KEY

  # - git tag -a builds/${DRONE_BUILD_NUMBER} -m "Tagging build"

trigger:
  branch:
    - master
