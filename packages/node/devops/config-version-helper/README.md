# @thrashplay/config-version-helper
This library can be used to generate hash-based version strings for Docker Swarm
configs and secrets. These version strings can then be used to generate unique-enough names for
these resources, allowing them to be rotated in an automated fashion.

## Overview

Docker Swarm configuration resources are immutable. This means that deploying new configuration
values requires stopping the service(s) using that configuration, deleting the old configuration,
and then deploying the new configuration before the service can be restarted. 
[The Docker documentation](https://docs.docker.com/engine/swarm/configs/#example-rotate-a-config) 
suggests an alternate appraoch of *rotating* configuration, which means you deploy a new version 
of the config with a new name, and then redeploy the relevant services with references to the 
new config. In order to automate this process, a continuous deployment system needs a way to 
generate (mostly) unique new names for configurations.  This library provides a set of tools -- a
command line tool, a high-level API, and a low-level API -- to help meet this requirement.

### How it Works

The Config Version Helper uses hashes of the configuration content to help generate a unique name
for that configuration. It works by processing the definition of one or more Docker Swarm stacks,
and identifying each config entry defined in the stack(s). A variable name is created 
based on the `config` entry's ID. By default this name is generated by converting the config's ID
to "snake case", and then changing every letter to uppercase. After this, the string `_VERSION` 
is appended to the name. For example, `my-config` becomes `MY_CONFIG_VERSION` and `test` becomes 
`TEST_VERSION`.

Once the variable name is determined, a version string is calculated by generating a truncated 
SHA256 hash of the `config` file's contents. It is expected that the user of this library
would import these variables into the environment before deploying the stack, and reference them
in the `name` field for each config entry.

All of the following examples assume a file called  `/path/to/docker-compose.yaml` exists, and 
has the following content:

```yaml
version: 3.7
service:
  image: anything/test:latest

configs:
  # external configs are ignored by the high-level API
  some_config:
    name: any-valid-name
    external: true
  # these will be processed - variable references are added manually to the names in the Yaml
  test_config1:
    name: test_config1_name-${TEST_CONFIG1_VERSION:-default}
    file: test_config1_file
  test2:
    name: test2-${TEST2_VERSION:-default}
    file: test2.conf
```

## CLI

The easiest way to use this library is via its command line interface and `npx`. The most basic 
usage only requires the path the stack's `docker-compose.yaml` file:

```bash
npx @thrashplay/config-version-helper -f /path/to/docker-compose.yaml
```

This will create a `.env` in the same directory as the compose file, containing the version 
information. This file will look similar to the following:

```bash
TEST_CONFIG1_VERSION=4f53cda1
TEST2_VERSION=f4d07d79
```

**Note that this will overwrite the contents of the .env file,** and should not be used if you 
specify other values in it.

### Arguments

The CLI interface provides additional arguments, for specifying multiple Docker compose files,
customizing the name of the output file, and more.

```
npx @thrashplay/config-version-helper

Generate version information from a stack's docker-compose.yaml file

Options:
  --help            Show help                                          [boolean]
  --version         Show version number                                [boolean]
  -f, --stack-file  The docker-compose file to process; may be specified
                    multiple times                            [array] [required]
  -o, --output      The name of the file to save environment variables in,
                    relative to the stack Yaml          [string] [default: .env]
  -q, --quiet       Disable all non-error output      [boolean] [default: false]
```

**--stack-file**   
One or more `--stack-file` arguments are used to specify the docker-compse.yaml
file(s) to process.

**--output**   
The `--output` argument specifies the relative path to the environment file to store the result 
values in. Note that one file will be generated for every declared `--stack-file`, with the 
full path being generated by using the stack file's directory as a base.  **NOTE:** Currently
this means multiple files cannot be processed at the same time, since they will overwrite each 
other's output.

**--quiet**   
Suppress all non-error output.

## High-Level API

To be completed.

## Low-Level API

To be completed.
