version: '3.7'
services:
  homeassistant:
    image: "homeassistant/home-assistant:stable"
    configs: 
      - source: automations
        target: /config/automations.json
        mode: 0440
      - source: configuration
        target: /config/configuration.json
        mode: 0440
      - source: groups
        target: /config/groups.json
        mode: 0440
      - source: scenes
        target: /config/scenes.json
        mode: 0440
      - source: scripts
        target: /config/scripts.json
        mode: 0440
    entrypoint: "ln -s /run/secrets/homeassistant-secrets secrets.yaml && /bin/entry.sh python3 -m homeassistant --config /config"
    environment:
      - TZ=America/Chicago
    secrets:
      - homeassistant-secrets
    volumes:
      - db:/config/home-assistant_v2.db
      - storage:/config/.storage 

configs:
  automations:
    name: automations-config-${AUTOMATIONS_CONFIG_VERSION:-default}
    file: ./config/automations.yaml
  configuration:
    name: configuration-config-${CONFIGURATIONS_CONFIG_VERSION:-default}
    file: ./config/configuration.yaml
  groups:
    name: groups-config-${GROUPS_CONFIG_VERSION:-default}
    file: ./config/groups.yaml
  scenes:
    name: scenes-config-${SCENES_CONFIG_VERSION:-default}
    file: ./config/scenes.yaml
  scripts:
    name: scripts-config-${SCRIPTS_CONFIG_VERSION:-default}
    file: ./config/scripts.yaml
    
networks:
  default:
    external: true
    name: proxy

secrets:
  homeassistant-secrets:
    external: true

volumes:
  db:
    driver: local
    driver_opts:
      type: none
      device: /mnt/homeassistant/home-assistant_v2.db
      o: bind
  storage:
    driver: local
    driver_opts:
      type: none
      device: /mnt/homeassistant/storage
      o: bind