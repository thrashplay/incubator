#!/usr/bin/env sh

SCRIPT=$(readlink -f "$0")
DIR=$(dirname "$SCRIPT")
HOST=$(cat /etc/hostname)

if [ -z $1 ]; then
  echo "Usage: bootstrap <manager-ip> <secrets-path>" 
  exit 1
fi
if [ -z $2 ]; then
  echo "Usage: bootstrap <manager-ip> <secrets-path>" 
  exit 1
fi

deploy_stack () {
  docker stack deploy --compose-file "$DIR/../bootstrap/$1/docker-compose.yaml" $1
}

set -e
set -x

${DIR}/bootstrap-dist/load-netshare

docker swarm init --advertise-addr $1
docker node update --label-add public $HOST

docker network create -d overlay --attachable proxy

$DIR/load-secrets $2

docker run -d --name nfs \
  --privileged \
  --restart unless-stopped \
  -v /srv/nfs:/nfs.01 \
  -e SHARED_DIRECTORY=/nfs.01 \
  -e SYNC=true \
  --net=host \
  itsthenetwork/nfs-server-alpine:11-arm

deploy_stack drone