#!/usr/bin/env bash



read -r -d '' HELP_TEXT <<-HELP
Usage: download-and-verify [OPTION]... <URL>
Downloads a file, and verifies it matches a checksum.

If this command completes successfully, then the file with the supplied URL will be downloaded and
saved at the path given by '--destination.' Additionally, if '--keep-checksum' was supplied then the
SHA256 checksum file will be stored at the same pathname, with '.sha256' appended. If the download 
fails, or if the checksum is invalid, then the destination will not have been changed.

Requires the verify-single-sha256 utility to be on the path.

The following options are required:
      --destination=<dest>  path at which the downloaded file be saved
      --keep-checksum       if this flag is specified, the checksum file be saved
      --sha256-url=<url>    URL to a generated by sha256sum, containing the downloaded file's checksum

The following additional arguments may be specified:
  -h, --help                show this help message
HELP

function parse_args ()
{
  for i in "$@"; do
    case $i in
        --keep-checksum)
        KEEP_CHECKSUM=true
        shift
        ;;
        --sha256-url=*)
        SHA256_URL="${i#*=}"
        shift
        ;;
        -h|--help)
        SHOW_HELP=true
        shift
        ;;
        *)
        [[ -z "${URL}" ]] || { echo "Only one URL may be specified."; exit 1; }
        URL="${i}"
        ;;
    esac
  done
}

parse_args "$@"|| exit 1

if [[ "${SHOW_HELP}" == "true" ]]; then
  echo "${HELP_TEXT}"
  exit 0
fi

TEMP_DOWNLOAD_DIR=$(mktemp -d "download-XXXXXXXXXX")
trap 'rm -rf -- "${TEMP_DOWNLOAD_DIR}"' INT TERM HUP EXIT

# if no filename given as argument, extract from the URL
# See: https://unix.stackexchange.com/a/64435
if [[ -z "${FILENAME}" ]]; then
  FILENAME="${URL##*/}"
fi

set -x

# download to temp file
curl --location --silent --output "${TEMP_DOWNLOAD_DIR}/${FILENAME}" "${URL}"
cp "/d/sandbox/incubator-node/packages/pegasus-ops/k3os/images-src/raspios_lite/2020-05-28/armhf/2020-05-27-raspios-buster-lite-armhf.zip.sha256" "${TEMP_DOWNLOAD_DIR}"

verify-single-sha256 \
  --file=2020-05-27-raspios-buster-lite-armhf.zip \
  --sums="${TEMP_DOWNLOAD_DIR}/2020-05-27-raspios-buster-lite-armhf.zip.sha256" \
    || exit 1

